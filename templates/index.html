<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bearing Fault Analyzer - AI-Powered Vibration Analysis</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="{{ url_for('index') }}" class="logo" style="text-decoration: none; color: inherit;">
          <div class="logo-icon">âš™ï¸</div>
          <span>Bearing Fault Analyzer</span>
        </a>
        <div class="header-info">
          <a href="{{ url_for('history') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ“š íˆìŠ¤í† ë¦¬</a>
          <a href="{{ url_for('samples') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ“¦ ìƒ˜í”Œ ë°ì´í„°</a>
          <a href="{{ url_for('manual') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ‘€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
          <button class="theme-toggle" id="themeToggle" aria-label="í…Œë§ˆ ë³€ê²½"></button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Hero Section -->
    <div class="hero-section">
      <h1>ğŸ”§ ë² ì–´ë§ ê²°í•¨ ë¶„ì„ê¸°</h1>
      <p style="font-size: 18px; color: var(--text-secondary); margin-bottom: 30px; text-align: center;">
        AI ê¸°ë°˜ ì§„ë™ ì‹ í˜¸ ë¶„ì„ìœ¼ë¡œ ë² ì–´ë§ ìƒíƒœë¥¼ ì •í™•í•˜ê²Œ ì§„ë‹¨í•˜ì„¸ìš”
      </p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for m in messages %}<p>{{ m }}</p>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Upload Section -->
    <div class="upload-section">
      <div class="upload-header">
        <h2>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</h2>
        <p>ì§„ë™ ì‹ í˜¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
      </div>

      <form action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data" id="uploadForm">
        <div class="file-upload-area">
      
          <!-- â¬‡ï¸ íŒŒì¼ì •ë³´ ë¸”ë¡ì„ ìœ„ë¡œ ì´ë™ -->
          <div id="fileInfo" class="file-info" style="display: none;">
            <!-- <div id="fileName"></div> -->
            <div class="file-meta">
              <span id="fileName"></span><span id="fileSize"></span> Â· <span id="fileType"></span>
            </div>
          </div>

          <!-- Audio Player for WAV files -->
          <div id="audioPlayer" class="audio-player">
            <div class="audio-controls">
              <button id="playBtn" class="play-btn">â–¶ï¸</button>
              <div class="audio-info">
                <div id="audioFileName">-</div>
                <div id="audioDuration">Duration: --:--</div>
              </div>
            </div>
            <div class="waveform">
              <div class="waveform-bars" id="waveformBars">
                <!-- Waveform bars will be generated here -->
              </div>
            </div>
            <audio id="audioElement" preload="metadata"></audio>
          </div>
      
          <div class="file-input-wrapper">
            <input type="file" name="file" id="fileInput" class="file-input" accept=".wav,.csv" required />
            <label for="fileInput" class="file-input-label">
              <span class="upload-icon">ğŸ“¤</span>
              <span class="upload-text">íŒŒì¼ ì„ íƒí•˜ê¸°</span>
            </label>
          </div>
        </div>
      
        <div class="form-row">
          <div class="form-group">
            <label for="sr">ğŸµ ìƒ˜í”Œë§ ë ˆì´íŠ¸ (Hz)</label>
            <input type="number" name="sr" id="sr" value="25600" min="1000" step="100" placeholder="ê¸°ë³¸ê°’: 25600" />
          </div>
      
          <!-- â¬‡ï¸ ì…ë ¥ì°½ê³¼ ê°™ì€ ì¤„ì—ì„œ ì •ë ¬ë¨ -->
          <button type="submit" class="analyze-btn" id="submitBtn">
            <span id="btnText">ğŸš€ ë¶„ì„ ì‹œì‘</span>
            <span id="btnLoading" class="loading" style="display: none;"></span>
          </button>
        </div>
      </form>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progressOverlay">
      <div class="progress-container">
        <div class="progress-title">ğŸ” AI ë¶„ì„ ì§„í–‰ ì¤‘...</div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="progress-text" id="progressText">ì¤€ë¹„ ì¤‘...</div>
        <div class="progress-steps">
          <div class="progress-step" id="step1">
            <div class="progress-step-icon">ğŸ“</div>
            <span>íŒŒì¼ ì—…ë¡œë“œ</span>
          </div>
          <div class="progress-step" id="step2">
            <div class="progress-step-icon">ğŸµ</div>
            <span>ì‹ í˜¸ ì²˜ë¦¬</span>
          </div>
          <div class="progress-step" id="step3">
            <div class="progress-step-icon">ğŸ“Š</div>
            <span>ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ìƒì„±</span>
          </div>
          <div class="progress-step" id="step4">
            <div class="progress-step-icon">ğŸ¤–</div>
            <span>AI ëª¨ë¸ ë¶„ì„</span>
          </div>
          <div class="progress-step" id="step5">
            <div class="progress-step-icon">ğŸ“ˆ</div>
            <span>ê²°ê³¼ ìƒì„±</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <div class="features-section">
      <h2>âœ¨ ì£¼ìš” ê¸°ëŠ¥</h2>
      <div class="features-row">
        <div class="feature-item">
          <div class="feature-icon">ğŸ¯</div>
          <div class="feature-title">ì •í™•í•œ ì§„ë‹¨</div>
          <div class="feature-desc">ResNet50 AI ëª¨ë¸ì„ í†µí•œ ê³ ì •ë°€ ë² ì–´ë§ ìƒíƒœ ë¶„ì„</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ“Š</div>
          <div class="feature-title">ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨</div>
          <div class="feature-desc">ì§„ë™ ì‹ í˜¸ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ íŒ¨í„´ ë¶„ì„</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">âš¡</div>
          <div class="feature-title">ì‹¤ì‹œê°„ ë¶„ì„</div>
          <div class="feature-desc">ë¹ ë¥¸ ì²˜ë¦¬ ì†ë„ë¡œ ì¦‰ì‹œ ê²°ê³¼ í™•ì¸</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ”</div>
          <div class="feature-title">ë‹¤ì–‘í•œ í˜•ì‹</div>
          <div class="feature-desc">WAV, CSV ë“± ë‹¤ì–‘í•œ ë°ì´í„° í˜•ì‹ ì§€ì›</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('theme') || 'dark';
    
    // Apply saved theme
    document.documentElement.setAttribute('data-theme', currentTheme);
    
    themeToggle.addEventListener('click', function() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });

    // Audio player functionality
    let audioElement = null;
    let isPlaying = false;

    function generateWaveform() {
      const waveformBars = document.getElementById('waveformBars');
      waveformBars.innerHTML = '';
      
      for (let i = 0; i < 50; i++) {
        const bar = document.createElement('div');
        bar.className = 'waveform-bar';
        bar.style.height = Math.random() * 80 + 20 + '%';
        waveformBars.appendChild(bar);
      }
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // File input handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const fileType = document.getElementById('fileType');
      const audioPlayer = document.getElementById('audioPlayer');
      const audioFileName = document.getElementById('audioFileName');
      const audioDuration = document.getElementById('audioDuration');
      
      if (file) {
        fileName.textContent = `ğŸ“„ ${file.name}`;
        fileSize.textContent = `ğŸ“ ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        fileType.textContent = `ğŸ“‹ ${file.type || file.name.split('.').pop().toUpperCase()}`;
        fileInfo.style.display = 'block';
        
        // Show audio player for WAV files
        if (file.name.toLowerCase().endsWith('.wav')) {
          audioPlayer.style.display = 'block';
          audioFileName.textContent = file.name;
          
          // Create audio element
          if (audioElement) {
            audioElement.pause();
          }
          
          audioElement = document.getElementById('audioElement');
          const audioURL = URL.createObjectURL(file);
          audioElement.src = audioURL;
          
          // Generate waveform visualization
          generateWaveform();
          
          audioElement.addEventListener('loadedmetadata', function() {
            audioDuration.textContent = `Duration: ${formatTime(audioElement.duration)}`;
          });
          
          audioElement.addEventListener('timeupdate', function() {
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            const bars = document.querySelectorAll('.waveform-bar');
            const activeIndex = Math.floor((progress / 100) * bars.length);
            
            bars.forEach((bar, index) => {
              if (index <= activeIndex) {
                bar.classList.add('active');
              } else {
                bar.classList.remove('active');
              }
            });
          });
          
          audioElement.addEventListener('ended', function() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = 'â–¶ï¸';
            document.querySelectorAll('.waveform-bar').forEach(bar => {
              bar.classList.remove('active');
            });
          });
          
        } else {
          audioPlayer.style.display = 'none';
        }
      } else {
        fileInfo.style.display = 'none';
        audioPlayer.style.display = 'none';
      }
    });

    // Play/Pause button functionality
    document.getElementById('playBtn').addEventListener('click', function() {
      if (!audioElement) return;
      
      if (isPlaying) {
        audioElement.pause();
        this.textContent = 'â–¶ï¸';
        isPlaying = false;
      } else {
        audioElement.play();
        this.textContent = 'â¸ï¸';
        isPlaying = true;
      }
    });

    // Progress bar functionality
    function showProgress() {
      const overlay = document.getElementById('progressOverlay');
      const progressBar = document.getElementById('progressBarFill');
      const progressText = document.getElementById('progressText');
      
      overlay.style.display = 'flex';
      
      const steps = [
        { id: 'step1', text: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', progress: 20 },
        { id: 'step2', text: 'ì‹ í˜¸ ì²˜ë¦¬ ì¤‘...', progress: 40 },
        { id: 'step3', text: 'ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ìƒì„± ì¤‘...', progress: 60 },
        { id: 'step4', text: 'AI ëª¨ë¸ ë¶„ì„ ì¤‘...', progress: 80 },
        { id: 'step5', text: 'ê²°ê³¼ ìƒì„± ì¤‘...', progress: 100 }
      ];
      
      let currentStep = 0;
      
      function updateStep() {
        if (currentStep > 0) {
          document.getElementById(steps[currentStep - 1].id).classList.add('completed');
          document.getElementById(steps[currentStep - 1].id).classList.remove('active');
        }
        
        if (currentStep < steps.length) {
          document.getElementById(steps[currentStep].id).classList.add('active');
          progressText.textContent = steps[currentStep].text;
          progressBar.style.width = steps[currentStep].progress + '%';
          currentStep++;
          
          setTimeout(updateStep, 1500 + Math.random() * 1000);
        }
      }
      
      setTimeout(updateStep, 500);
    }

    // Form submission handling
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnLoading = document.getElementById('btnLoading');
      
      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
      
      // Show progress overlay
      showProgress();
    });
  </script>
</body>
</html>