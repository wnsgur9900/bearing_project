<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¶„ì„ ê²°ê³¼ - Bearing Fault Analyzer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="{{ url_for('index') }}" class="logo" style="text-decoration: none; color: inherit;">
          <div class="logo-icon" style="color: inherit;">âš™ï¸</div>
          <span style="color: inherit;">Bearing Fault Analyzer</span>
        </a>
        <div class="header-info">
          <a href="{{ url_for('history') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ“š íˆìŠ¤í† ë¦¬</a>
          <a href="{{ url_for('samples') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ“¦ ìƒ˜í”Œ ë°ì´í„°</a>
          <a href="{{ url_for('manual') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; text-decoration: none; margin-right: 8px;">ğŸ‘€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
          <button class="theme-toggle" id="themeToggle" aria-label="í…Œë§ˆ ë³€ê²½"></button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>ğŸ“Š ë¶„ì„ ê²°ê³¼</h1>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ p_normal }}%</div>
        <div class="stat-label">Normal í™•ë¥ </div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ p_fault }}%</div>
        <div class="stat-label">Fault í™•ë¥ </div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ sr }}</div>
        <div class="stat-label">ìƒ˜í”Œë§ ë ˆì´íŠ¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ filename[:20] }}{% if filename|length > 20 %}...{% endif %}</div>
        <div class="stat-label">ë¶„ì„ íŒŒì¼</div>
      </div>
    </div>

    <!-- Main Results Grid -->
    <div class="grid-2">
      <!-- Prediction Card -->
      <div class="card prediction-card">
        <h2>ğŸ¯ AI ì§„ë‹¨ ê²°ê³¼</h2>
        <div class="pred {{ 'ok' if pred=='Normal' else 'bad' }}">
          {{ pred }}
        </div>
        
        <div class="progress-container">
          <h3>Fault í™•ë¥ </h3>
          <div class="progress-bar">
            <div class="progress-fill fault" style="width: {{ p_fault }}%"></div>
          </div>
          <p style="text-align: center; margin-top: 8px; font-weight: 600;">
            {{ p_fault }}% ({{ 'ë†’ìŒ' if p_fault > 50 else 'ë‚®ìŒ' }})
          </p>
        </div>

        <div class="progress-container">
          <h3>Normal í™•ë¥ </h3>
          <div class="progress-bar">
            <div class="progress-fill normal" style="width: {{ p_normal }}%"></div>
          </div>
          <p style="text-align: center; margin-top: 8px; font-weight: 600;">
            {{ p_normal }}% ({{ 'ë†’ìŒ' if p_normal > 50 else 'ë‚®ìŒ' }})
          </p>
        </div>
      </div>

      <!-- Spectrogram Card -->
      <div class="card spec-container">
        <h2>ğŸ“ˆ ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨</h2>
        <img src="{{ spec_url }}" alt="spectrogram" class="spec-img"/>
        <p style="margin-top: 16px; color: var(--text-secondary); text-align: center;">
          ì§„ë™ ì‹ í˜¸ì˜ ì£¼íŒŒìˆ˜ íŠ¹ì„±ì„ ì‹œê°í™”í•œ ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨
        </p>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="chart-container" style="max-width: 500px; margin: 0 auto;">
      <h3 class="chart-title">í™•ë¥  ë¶„í¬</h3>
      <div style="position: relative; height: 300px; width: 100%;">
        <canvas id="probabilityChart"></canvas>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <div style="display: inline-block; margin: 0 20px;">
          <div style="display: inline-block; width: 20px; height: 20px; background: rgba(0, 255, 136, 0.8); border-radius: 4px; margin-right: 8px; vertical-align: middle;"></div>
          <span style="color: var(--text); font-weight: 600;">ì •ìƒ (Normal)</span>
        </div>
        <div style="display: inline-block; margin: 0 20px;">
          <div style="display: inline-block; width: 20px; height: 20px; background: rgba(255, 71, 87, 0.8); border-radius: 4px; margin-right: 8px; vertical-align: middle;"></div>
          <span style="color: var(--text); font-weight: 600;">ë¹„ì •ìƒ (Fault)</span>
        </div>
      </div>
    </div>

    <!-- Ensemble Analysis -->
    <div class="card">
      <h2>ğŸ¯ ì•™ìƒë¸” ë¶„ì„</h2>
      <div class="grid-3">
        <div>
          <h3>ğŸ“Š ìœˆë„ í†µê³„</h3>
          <p><strong>ìœˆë„ ê°œìˆ˜:</strong> <b>{{ n_windows }}</b></p>
          <p><strong>í‰ê·  Fault í™•ë¥ :</strong> <b>{{ p_fault }}%</b></p>
          <p><strong>ì„ê³„ì¹˜(0.7) ì´ˆê³¼ ìœˆë„ ë¹„ìœ¨:</strong> <b>{{ over_th }}%</b></p>
        </div>
        <div>
          <h3>ğŸ” ì‹ ë¢°ë„ ì§€í‘œ</h3>
          <p><strong>í‰ê·  Max-Softmax:</strong> <b>{{ mean_maxp }}</b> 
            {% if low_conf %}<span class="badge warn">Low confidence</span>{% endif %}</p>
          <p><strong>í‰ê·  ì—”íŠ¸ë¡œí”¼:</strong> <b>{{ mean_entropy }}</b></p>
          <p><strong>ì‹ ë¢°ë„ ìƒíƒœ:</strong> 
            {% if low_conf %}
              <span class="badge warn">ì €ì‹ ë¢°</span>
            {% else %}
              <span class="badge ok">ì •ìƒ</span>
            {% endif %}
          </p>
        </div>
        <div>
          <h3>ğŸ“ˆ ìµœì¢… íŒë‹¨</h3>
          <p><strong>ê²°ì • ê·œì¹™:</strong> ì•™ìƒë¸” ê¸°ë°˜</p>
          <p><strong>ìœˆë„ í¬ê¸°:</strong> 1.0ì´ˆ</p>
          <p><strong>ì˜¤ë²„ë©:</strong> 0.5ì´ˆ</p>
        </div>
      </div>
    </div>

    <!-- Window Settings -->
    <div class="card">
      <h2>âš™ï¸ ìœˆë„ ì„¤ì •</h2>
      {% if short_mode %}
        <p><span class="badge warn">Short-signal mode</span> ê¸¸ì´ê°€ ì§§ì•„ ì „ì²´ ì‹ í˜¸/ë‹¨ì¶• ìœˆë„ìš°ë¡œ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>
      {% else %}
        <p><span class="badge ok">Standard</span> í‘œì¤€ ìœˆë„ ì„¤ì •ìœ¼ë¡œ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>
      {% endif %}
      <div class="grid-3">
        <div>
          <p><strong>ì‚¬ìš©í•œ ìœˆë„:</strong> <b>{{ "%.2f"|format(win_used) }} s</b></p>
          <p><strong>í™‰ í¬ê¸°:</strong> <b>{{ "%.2f"|format(hop_used) }} s</b></p>
        </div>
        <div>
          <p><strong>ìœˆë„ ê°œìˆ˜:</strong> <b>{{ n_windows }}</b></p>
          <p><strong>ì‹ í˜¸ ê¸¸ì´:</strong> <b>{{ "%.2f"|format(qc.length_sec) }} s</b></p>
        </div>
        <div>
          <p><strong>ë¶„ì„ ëª¨ë“œ:</strong> 
            {% if short_mode %}
              <span class="badge warn">ë‹¨ì¼ ìœˆë„</span>
            {% else %}
              <span class="badge ok">ë‹¤ì¤‘ ìœˆë„</span>
            {% endif %}
          </p>
          <p><strong>Fallback ì‚¬ìš©:</strong> 
            {% if short_mode %}
              <span class="badge info">ì˜ˆ</span>
            {% else %}
              <span class="badge ok">ì•„ë‹ˆì˜¤</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- QC Metrics -->
    <div class="card">
      <h2>ğŸ”§ í’ˆì§ˆ(QC) ì§€í‘œ</h2>
      <div class="grid-2">
        <div>
          <h3>ğŸ“ ì‹ í˜¸ íŠ¹ì„±</h3>
          <ul style="list-style: none; padding: 0;">
            <li><strong>ê¸¸ì´:</strong> {{ "%.2f"|format(qc.length_sec) }} s</li>
            <li><strong>RMS:</strong> {{ "%.6f"|format(qc.rms) }}</li>
            <li><strong>DC ì˜¤í”„ì…‹:</strong> {{ "%.6f"|format(qc.dc_offset) }}</li>
            <li><strong>Crest factor:</strong> {{ "%.2f"|format(qc.crest_factor) }}</li>
          </ul>
        </div>
        <div>
          <h3>ğŸ“Š ì£¼íŒŒìˆ˜ íŠ¹ì„±</h3>
          <ul style="list-style: none; padding: 0;">
            <li><strong>Clipping rate:</strong> {{ "%.2f"|format(qc.clipping_rate * 100) }}%</li>
            <li><strong>ZCR:</strong> {{ "%.4f"|format(qc.zcr) }}</li>
            <li><strong>Spectral centroid:</strong> {{ "%.1f"|format(qc.spectral_centroid) }} Hz</li>
            <li><strong>Band-energy ratio:</strong> {{ "%.3f"|format(qc.band_energy_ratio) }}</li>
          </ul>
        </div>
      </div>

      {% if warns and warns|length > 0 %}
        <h3 style="margin-top: 20px;">âš ï¸ ê²½ê³  ë° ì•Œë¦¼</h3>
        <div style="margin-top: 10px;">
          {% for level, msg in warns %}
            <div style="margin: 8px 0; padding: 8px 12px; border-radius: 6px; 
                        background: {% if level=='error' %}rgba(231, 76, 60, 0.1){% elif level=='warn' %}rgba(241, 196, 15, 0.1){% else %}rgba(52, 152, 219, 0.1){% endif %}; 
                        border-left: 4px solid {% if level=='error' %}var(--bad){% elif level=='warn' %}var(--warning){% else %}var(--accent){% endif %};">
              <span class="badge {{ 'bad' if level=='error' else ('warn' if level=='warn' else 'info') }}">{{ level.upper() }}</span> 
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="margin-top: 20px; text-align: center; padding: 16px; background: rgba(0, 255, 136, 0.1); border-radius: 8px; border: 1px solid var(--good);">
          <span class="badge ok">OK</span> <strong>ì´ìƒ ì§•í›„ ì—†ìŒ</strong>
        </div>
      {% endif %}
    </div>

    <!-- Frequency Analysis -->
    <div class="card">
      <h2>ğŸ”¬ ìƒì„¸ ì£¼íŒŒìˆ˜ ë¶„ì„</h2>
      
      <!-- Spectrum Chart -->
      <div class="freq-chart-container">
        <h3>ì£¼íŒŒìˆ˜ ìŠ¤í™íŠ¸ëŸ¼</h3>
        <canvas id="spectrumChart" width="800" height="300"></canvas>
      </div>
      
      <!-- Peak Analysis -->
      <div class="grid-2" style="margin-top: 30px;">
        <div>
          <h3>ğŸ¯ ì£¼ìš” ì£¼íŒŒìˆ˜ í”¼í¬</h3>
          <div class="peaks-list">
            {% for i in range(freq_analysis.peaks.frequencies|length) %}
            <div class="peak-item">
              <span class="peak-freq">{{ "%.1f"|format(freq_analysis.peaks.frequencies[i]) }} Hz</span>
              <span class="peak-magnitude">{{ "%.2e"|format(freq_analysis.peaks.magnitudes[i]) }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <div>
          <h3>ğŸ“Š ì£¼íŒŒìˆ˜ ëŒ€ì—­ë³„ ì—ë„ˆì§€</h3>
          <div class="band-energies">
            {% for band_name, band_data in freq_analysis.band_energies.items() %}
            <div class="band-item">
              <div class="band-info">
                <span class="band-name">{{ band_name }}</span>
                <span class="band-percentage">{{ "%.1f"|format(band_data.percentage) }}%</span>
              </div>
              <div class="band-bar">
                <div class="band-fill" style="width: {{ band_data.percentage }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- Spectral Statistics -->
      <div class="grid-2" style="margin-top: 30px;">
        <div>
          <h3>ğŸ“ˆ ìŠ¤í™íŠ¸ëŸ¼ í†µê³„</h3>
          <div class="stats-table">
            <div class="stat-row">
              <span class="stat-name">ì¤‘ì‹¬ ì£¼íŒŒìˆ˜:</span>
              <span class="stat-value">{{ "%.1f"|format(freq_analysis.statistics.spectral_centroid) }} Hz</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">ë¶„ì‚° (Spread):</span>
              <span class="stat-value">{{ "%.1f"|format(freq_analysis.statistics.spectral_spread) }} Hz</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">ë¹„ëŒ€ì¹­ë„ (Skewness):</span>
              <span class="stat-value">{{ "%.3f"|format(freq_analysis.statistics.spectral_skewness) }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">ì²¨ë„ (Kurtosis):</span>
              <span class="stat-value">{{ "%.3f"|format(freq_analysis.statistics.spectral_kurtosis) }}</span>
            </div>
          </div>
        </div>
        
        <div>
          <h3>ğŸ¼ í•˜ëª¨ë‹‰ ë¶„ì„</h3>
          {% if freq_analysis.harmonics %}
          <div class="harmonics-list">
            {% for harmonic in freq_analysis.harmonics %}
            <div class="harmonic-item">
              <span class="harmonic-order">{{ harmonic.order }}ì°¨</span>
              <span class="harmonic-freq">{{ "%.1f"|format(harmonic.frequency) }} Hz</span>
              <span class="harmonic-magnitude">{{ "%.2e"|format(harmonic.magnitude) }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p style="color: var(--text-secondary);">ëª…í™•í•œ í•˜ëª¨ë‹‰ íŒ¨í„´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="card">
      <h2>ğŸ” ìƒì„¸ ë¶„ì„ ì •ë³´</h2>
      <div class="grid-3">
        <div>
          <h3>ğŸ“ íŒŒì¼ ì •ë³´</h3>
          <p><strong>íŒŒì¼ëª…:</strong> {{ filename }}</p>
          <p><strong>ìƒ˜í”Œë§ ë ˆì´íŠ¸:</strong> {{ sr }} Hz</p>
          <p><strong>ë¶„ì„ ì‹œê°„:</strong> <span id="analysisTime"></span></p>
        </div>
        <div>
          <h3>ğŸ¤– AI ëª¨ë¸ ì •ë³´</h3>
          <p><strong>ëª¨ë¸:</strong> ResNet50 (1ì±„ë„)</p>
          <p><strong>ì…ë ¥ í¬ê¸°:</strong> 224Ã—224</p>
          <p><strong>ì „ì²˜ë¦¬:</strong> Grayscale, Normalize</p>
        </div>
        <div>
          <h3>ğŸ“Š ì‹ í˜¸ ì²˜ë¦¬</h3>
          <p><strong>ë³€í™˜:</strong> ë©œ ìŠ¤í™íŠ¸ë¡œê·¸ë¨</p>
          <p><strong>FFT í¬ê¸°:</strong> 1024</p>
          <p><strong>ë©œ ë¹ˆ:</strong> 128</p>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="text-align: center; margin: 40px 0;">
      <a class="btn" href="{{ url_for('index') }}">ğŸ”„ ìƒˆ ë¶„ì„í•˜ê¸°</a>
      <button class="btn btn-secondary" onclick="window.print()" style="margin-left: 16px;">ğŸ–¨ï¸ ê²°ê³¼ ì¸ì‡„</button>
    </div>

  </div>

  <script>
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('theme') || 'dark';
    
    // Apply saved theme
    document.documentElement.setAttribute('data-theme', currentTheme);
    
    themeToggle.addEventListener('click', function() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update chart colors when theme changes
      updateChartTheme();
    });

    // Function to update chart theme
    function updateChartTheme() {
      const colors = getChartTextColors();
      
      // Update probability chart
      probabilityChart.options.plugins.tooltip.backgroundColor = colors.tooltip.background;
      probabilityChart.options.plugins.tooltip.titleColor = colors.tooltip.text;
      probabilityChart.options.plugins.tooltip.bodyColor = colors.tooltip.text;
      probabilityChart.options.plugins.tooltip.borderColor = colors.tooltip.border;
      probabilityChart.update();
      
      // Update spectrum chart
      spectrumChart.options.plugins.tooltip.backgroundColor = colors.tooltip.background;
      spectrumChart.options.plugins.tooltip.titleColor = colors.tooltip.text;
      spectrumChart.options.plugins.tooltip.bodyColor = colors.tooltip.text;
      spectrumChart.options.plugins.tooltip.borderColor = colors.tooltip.border;
      
      spectrumChart.options.scales.x.title.color = colors.text;
      spectrumChart.options.scales.x.ticks.color = colors.text;
      spectrumChart.options.scales.y.title.color = colors.text;
      spectrumChart.options.scales.y.ticks.color = colors.text;
      
      spectrumChart.update();
    }

    // Set analysis time
    document.getElementById('analysisTime').textContent = new Date().toLocaleString('ko-KR');

    // Probability Pie Chart
    const probCtx = document.getElementById('probabilityChart').getContext('2d');
    const probabilityChart = new Chart(probCtx, {
      type: 'doughnut',
      data: {
        labels: ['ì •ìƒ (Normal)', 'ë¹„ì •ìƒ (Fault)'],
        datasets: [{
          data: [{{ p_normal }}, {{ p_fault }}],
          backgroundColor: [
            'rgba(0, 255, 136, 0.8)',
            'rgba(255, 71, 87, 0.8)'
          ],
          borderColor: [
            'rgba(0, 255, 136, 1)',
            'rgba(255, 71, 87, 1)'
          ],
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                return `${label}: ${value}%`;
              }
            },
            backgroundColor: getChartTextColors().tooltip.background,
            titleColor: getChartTextColors().tooltip.text,
            bodyColor: getChartTextColors().tooltip.text,
            borderColor: getChartTextColors().tooltip.border,
            borderWidth: 1
          }
        }
      }
    });

    // Function to get theme-based colors
    function getChartTextColors() {
      const theme = document.documentElement.getAttribute('data-theme') || 'dark';
      return {
        text: theme === 'dark' ? '#ffffff' : '#333333',
        tooltip: {
          background: theme === 'dark' ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)',
          text: theme === 'dark' ? '#ffffff' : '#333333',
          border: theme === 'dark' ? '#ffffff' : '#333333'
        }
      };
    }

    // Frequency Spectrum Chart
    const spectrumCtx = document.getElementById('spectrumChart').getContext('2d');
    const freqData = {{ freq_analysis.spectrum.frequencies | safe }};
    const magnitudeData = {{ freq_analysis.spectrum.magnitudes | safe }};
    
    const spectrumChart = new Chart(spectrumCtx, {
      type: 'line',
      data: {
        labels: freqData.map(f => f.toFixed(0)),
        datasets: [{
          label: 'Magnitude',
          data: magnitudeData,
          borderColor: 'rgba(0, 212, 255, 0.8)',
          backgroundColor: 'rgba(0, 212, 255, 0.1)',
          borderWidth: 2,
          fill: true,
          pointRadius: 0,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: getChartTextColors().tooltip.background,
            titleColor: getChartTextColors().tooltip.text,
            bodyColor: getChartTextColors().tooltip.text,
            borderColor: getChartTextColors().tooltip.border,
            borderWidth: 1,
            callbacks: {
              title: function(context) {
                return `ì£¼íŒŒìˆ˜: ${context[0].label} Hz`;
              },
              label: function(context) {
                return `í¬ê¸°: ${context.parsed.y.toExponential(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'ì£¼íŒŒìˆ˜ (Hz)',
              color: getChartTextColors().text
            },
            grid: {
              color: 'var(--border)'
            },
            ticks: {
              color: getChartTextColors().text,
              maxTicksLimit: 10
            }
          },
          y: {
            title: {
              display: true,
              text: 'Magnitude',
              color: getChartTextColors().text
            },
            grid: {
              color: 'var(--border)'
            },
            ticks: {
              color: getChartTextColors().text,
              callback: function(value) {
                return value.toExponential(1);
              }
            }
          }
        }
      }
    });

    // Add some animation effects
    document.addEventListener('DOMContentLoaded', function() {
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
          card.style.transition = 'all 0.6s ease';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, index * 100);
      });
    });
  </script>
</body>
</html>
